const e=new RegExp("\\s","g");class t{constructor(e,t){this._keyOptions={},this._observedChildren=[],this._regexOptions=[],this._dotNetRef=e,this._options=t}connect(e){if(this._options){if(!this._options.keys)throw"_options.keys: array of IKeyOptions expected";if(!this._options.class)throw"_options.class: CSS class name expected";if(!this._observer){this._element=e,this._observer=new MutationObserver(this.onDomChanged),this._observer.keyListener=this,this._observer.observe(this._element,{attributes:!1,childList:!0,subtree:!0}),this._observedChildren=[],this._keyOptions={},this._regexOptions=[];for(const e of this._options.keys)e&&e.key&&this.setKeyOption(e);for(const e of this._element.getElementsByClassName(this._options.class))this.attachHandlers(e)}}}disconnect(){if(this._observer&&(this._observer.disconnect(),this._observer=null,this._observedChildren))for(const e of this._observedChildren)this.detachHandlers(e)}setKeyOption(t){t.key.length>2&&t.key.startsWith("/")&&t.key.endsWith("/")?(t.regex=new RegExp(t.key.substring(1,t.key.length-1)),this._regexOptions.push(t)):this._keyOptions[t.key.toLowerCase()]=t,t.preventDown=(t.preventDown||"none").replace(e,"").toLowerCase(),t.preventUp=(t.preventUp||"none").replace(e,"").toLowerCase(),t.stopDown=(t.stopDown||"none").replace(e,"").toLowerCase(),t.stopUp=(t.stopUp||"none").replace(e,"").toLowerCase()}attachHandlers(e){this._observedChildren&&this._observedChildren.indexOf(e)>-1||(e.keyListener=this,e.addEventListener("keydown",this.onKeyDown),e.addEventListener("keyup",this.onKeyUp),this._observedChildren.push(e))}detachHandlers(e){e.removeEventListener("keydown",this.onKeyDown),e.removeEventListener("keyup",this.onKeyUp),this._observedChildren=this._observedChildren.filter((t=>t!==e))}matchesKeyCombination(e,t){if(!e||"none"===e)return!1;if("any"===e)return!0;var s=t.shiftKey,n=t.ctrlKey,o=t.altKey,i=t.metaKey,r=s||n||o||i;return!(!r||"key+any"!==e)||(!(r||!e.includes("key+none"))||!!r&&e.includes(`key${s?"+shift":""}${n?"+ctrl":""}${o?"+alt":""}${i?"+meta":""}`))}onDomChanged(e){var t=this.keyListener;if(!t)return;const s=t._options.class;if(s)for(const n of e){for(const e of n.addedNodes)e instanceof Element&&e.classList&&e.classList.contains(s)&&t.attachHandlers(e);for(const e of n.removedNodes)e instanceof Element&&e.classList&&e.classList.contains(s)&&t.detachHandlers(e)}}onKeyDown(e){var t=this.keyListener;if(!t)return;if(!(e instanceof KeyboardEvent))return;const s=e.key.toLowerCase();let n=!1;if(t._keyOptions.hasOwnProperty(s)){const o=t._keyOptions[s];t.processKeyDown(e,o),o.subscribeDown&&(n=!0)}for(const o of t._regexOptions)o.regex&&o.regex.test(s)&&(t.processKeyDown(e,o),o.subscribeDown&&(n=!0));if(n){const s=t.toKeyboardEventArgs(e);s.Type="keydown",t._dotNetRef.invokeMethodAsync("OnKeyDown",s)}}onKeyUp(e){var t=this.keyListener;if(!t)return;if(!(e instanceof KeyboardEvent))return;const s=e.key.toLowerCase();let n=!1;if(t._keyOptions.hasOwnProperty(s)){const o=t._keyOptions[s];t.processKeyUp(e,o),o.subscribeUp&&(n=!0)}for(const o of t._regexOptions)o.regex&&o.regex.test(s)&&(t.processKeyUp(e,o),o.subscribeUp&&(n=!0));if(n){const s=t.toKeyboardEventArgs(e);s.Type="keyup",t._dotNetRef.invokeMethodAsync("OnKeyUp",s)}}processKeyDown(e,t){this.matchesKeyCombination(t.preventDown,e)&&e.preventDefault(),this.matchesKeyCombination(t.stopDown,e)&&e.stopPropagation()}processKeyUp(e,t){this.matchesKeyCombination(t.preventUp,e)&&e.preventDefault(),this.matchesKeyCombination(t.stopUp,e)&&e.stopPropagation()}toKeyboardEventArgs(e){return{Key:e.key,Code:e.code,Location:e.location,Repeat:e.repeat,CtrlKey:e.ctrlKey,ShiftKey:e.shiftKey,AltKey:e.altKey,MetaKey:e.metaKey}}}function s(e,s,n){if(!s)throw"elementId: expected element id!";const o=document.getElementById(s);if(!o)throw"no element found for id: "+s;o.keyListener||(o.keyListener=new t(e,n)),o.keyListener.connect(o)}function n(e){var t=document.getElementById(e);t&&t.keyListener&&t.keyListener.disconnect()}function o(e,t){const s=document.getElementById(e);s&&s.keyListener&&s.keyListener.setKeyOption(t)}export{n as disconnectKeyEvent,s as listenForKeyEvent,o as updateKeyEvent};
//# sourceMappingURL=tavenem-keylistener.js.map
